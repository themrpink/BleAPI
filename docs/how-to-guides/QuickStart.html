<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickStart &mdash; CosmedBleLib 1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Discovering devices" href="DiscoveringDevices.html" />
    <link rel="prev" title="Welcome to CosmedBleLib’s documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> CosmedBleLib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">QuickStart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pre-requisites">Pre-requisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#discover-and-filter-advertising-devices">Discover and filter advertising devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pair-with-a-device">Pair with a device</a></li>
<li class="toctree-l2"><a class="reference internal" href="#discover-services-and-characteristics">Discover services and characteristics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#communicate-with-the-device">Communicate with the device</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unpairing-and-disconnect">Unpairing and disconnect</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="DiscoveringDevices.html">Discovering devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="Filter.html">Filtering advertising devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="Pairing.html">Pairing and unpairing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GattDiscovery.html">Gatt Discovery Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="GattCommunication.html">Gatt communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="HelperMethods.html">Helper Methods</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Troubleshooting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="issues.html">Known issues</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="../api_documentation/html/index.html#http://">Cosmed API Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.microsoft.com/en-us/windows/uwp/devices-sensors/bluetooth-low-energy-overview">Microsoft UWP BLE Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CosmedBleLib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>QuickStart</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/QuickStart.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="quickstart">
<h1>QuickStart<a class="headerlink" href="#quickstart" title="Permalink to this headline"></a></h1>
<p>The library functionalities are straigthforward to use.
We will see the sequential steps to follow to accomplish the followings results:</p>
<ol class="arabic simple">
<li><p>discover and filter advertising devices</p></li>
<li><p>pair with a device</p></li>
<li><p>discover services and characteristics</p></li>
<li><p>communicate with the device</p></li>
<li><p>unpair</p></li>
</ol>
<section id="pre-requisites">
<h2>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline"></a></h2>
<p>In order to use the library, access to the Windows 10 Apis must be granted. To do so, from Visual Studio, go to the Solution Explorer window of the working project and follow the following steps:</p>
<ol class="arabic simple">
<li><p>Right click on References. Select “Add Reference…” from the context menu. On the left of the Reference Manager, choose Browse and find the following file: C:Program Files (x86)Windows Kits10UnionMetadatawinmd. Add it to your project as a reference. Note: You will need to change the filter to “All Files”.</p></li>
<li><p>Right click on References. Select “Add Reference…” from the context menu. On the left of the Reference Manager, go to Browse and find the directory “C:Program Files (x86)Reference AssembliesMicrosoftFramework.NETCorev4.5”. Add System.Runtime.WindowsRuntime.dll to your project.</p></li>
</ol>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="_images/gestione_riferimenti.png"><img alt="Pre-requisites" src="_images/gestione_riferimenti.png" style="width: 777.5px; height: 162.5px;" /></a>
<figcaption>
<p><span class="caption-text"><em>These files should be added to the VS project references</em></span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="discover-and-filter-advertising-devices">
<h2>Discover and filter advertising devices<a class="headerlink" href="#discover-and-filter-advertising-devices" title="Permalink to this headline"></a></h2>
<ol class="arabic">
<li><p>Build a filter if needed. For doing that a FilterBuilder is available.</p></li>
<li><p>Instatiate a Watcher that will scan for advertising devices. To apply the desired filtering, the Watcher can be instatiated with the created filter, otherwise is possible to add and remove a filter later.</p></li>
<li><p>The scan can be started. BLE offers two kind of scanning: Active and Passive. The difference is that with Active scanning will ask for ScanResponse packets to the discovered devices where available, giving the opportunity of obtaining more data about the advertising devices. In this example we will use the Active scan option.</p></li>
<li><p>Once scanning has started is possible to check the results. If an advertising device with the filtered properties exists, it will accessible as a ICosmedBleAdvertisedDevice object from the following data collections:</p>
<blockquote>
<div><ul class="simple">
<li><p>AllDiscoveredDevice : includes all the devices discovered since the beginning of the actual scan.</p></li>
<li><p>RecentlyDiscoveredDevices: includes only the recently advertising device. The timeout con be set. It’s default value is 10 seconds.</p></li>
<li><p>LastDiscoveredDevices: includes only the devices that have advertised since the last access to the collection.</p></li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Discovery and filtering example</span><a class="headerlink" href="#id2" title="Permalink to this code"></a></div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span> <span class="c1">//Step 1: creates a filter for devices called &quot;HeartRateDevice&quot;</span>
 <span class="n">IFilter</span> <span class="n">filter</span> <span class="p">=</span> <span class="n">FilterBuilder</span><span class="p">.</span><span class="n">Init</span><span class="p">().</span><span class="n">SetLocalName</span><span class="p">(</span><span class="s">&quot;HeartRateDevice&quot;</span><span class="p">).</span><span class="n">BuildFilter</span><span class="p">();</span>

 <span class="c1">//Step 2: creates a scanner with the given filter</span>
 <span class="n">IBleScanner</span> <span class="n">scanner</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CosmedBluetoothLEAdvertisementWatcher</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>

 <span class="c1">//Step 3: starts an active scan</span>
 <span class="k">await</span> <span class="n">scanner</span><span class="p">.</span><span class="n">StartActiveScanning</span><span class="p">();</span>

 <span class="c1">//Step 4: checking the results until the scanner is stopped</span>
 <span class="k">while</span><span class="p">(</span><span class="n">scanner</span><span class="p">.</span><span class="n">status</span> <span class="p">!=</span> <span class="n">StateMachine</span><span class="p">.</span><span class="n">Stopped</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="c1">//waits some time to discover new devices</span>
     <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">2000</span><span class="p">);</span>

     <span class="c1">//this collection will be updated at every cycle of the while loop</span>
     <span class="kt">var</span> <span class="n">discoveredDevices</span> <span class="p">=</span> <span class="n">scanner</span><span class="p">.</span><span class="n">AllDiscoveredDevices</span><span class="p">;</span>

     <span class="c1">//scannig can be paused</span>
     <span class="n">scanner</span><span class="p">.</span><span class="n">PauseScanning</span><span class="p">();</span>

     <span class="c1">//iteration over the discovered devices</span>
     <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">device</span> <span class="k">in</span> <span class="n">discoveredDevices</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="c1">//we are only interested in connectable devices for further Gatt communication</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">IsConnectable</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="c1">//  ... see code snippet in the next section ...</span>
         <span class="p">}</span>
     <span class="p">}</span>

     <span class="c1">//scan can be restarted, or stopped to end the while loop</span>
     <span class="n">scanner</span><span class="p">.</span><span class="n">ResumeScanning</span><span class="p">();</span>
 <span class="p">}</span>
</pre></div>
</div>
</div>
<p>Iterating through the requested collection allows access to all the information transmitted by the filtered advertising devices. The desired advertising device can be selected reading this data.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Stopping and restarting a scan implies that the collections will be cleared. To maintain the data pause/resume options should be used.</p>
</div>
</section>
<section id="pair-with-a-device">
<h2>Pair with a device<a class="headerlink" href="#pair-with-a-device" title="Permalink to this headline"></a></h2>
<p>Once the remote device has been selected it must be instantiated as a new CosmedBleDevice. This will start a comunication with the remote device to obtain addictional data.
Then the pairing process can start. Minumum pairing security options should be specified. Windows will then apply the most secure pairing process shared by the pairing devices.
A function that manage the pairing process should be passed. Otherwise the default one can be used, which will use the console for confirming pairing options on client side.</p>
</section>
<section id="discover-services-and-characteristics">
<h2>Discover services and characteristics<a class="headerlink" href="#discover-services-and-characteristics" title="Permalink to this headline"></a></h2>
<p>The gatt discovery service offers the methods to discover services and characteristics.
The obtained services can be iterated to explore its characteristics.</p>
</section>
<section id="communicate-with-the-device">
<h2>Communicate with the device<a class="headerlink" href="#communicate-with-the-device" title="Permalink to this headline"></a></h2>
<p>In this example we see how to subscribe to notifications.
For each characteristic a check if it accepts subscription to notification will be automatically done by the subscription method.
To receive notifications and to handle errors during subscription custom functions will be passed to the subscription method.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Pairing, discovering services and characteristics, unpairing and disconnect example</span><a class="headerlink" href="#id3" title="Permalink to this code"></a></div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span> <span class="k">try</span>
 <span class="p">{</span>
     <span class="c1">//creates an instance of the remote device</span>
     <span class="n">CosmedBleDevice</span> <span class="n">connectionDevice</span> <span class="p">=</span> <span class="k">await</span> <span class="n">CosmedBleDevice</span><span class="p">.</span><span class="n">CreateAsync</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

     <span class="c1">//sets all the possible ceremony options. Windows will choose the most secure option</span>
     <span class="c1">//compatible with both devices</span>
     <span class="n">DevicePairingKinds</span> <span class="n">ceremonySelection</span> <span class="p">=</span> <span class="n">DevicePairingKinds</span><span class="p">.</span><span class="n">None</span> <span class="p">|</span>
                                             <span class="n">DevicePairingKinds</span><span class="p">.</span><span class="n">ConfirmOnly</span> <span class="p">|</span>
                                             <span class="n">DevicePairingKinds</span><span class="p">.</span><span class="n">ConfirmPinMatch</span> <span class="p">|</span>
                                             <span class="n">DevicePairingKinds</span><span class="p">.</span><span class="n">DisplayPin</span> <span class="p">|</span>
                                             <span class="n">DevicePairingKinds</span><span class="p">.</span><span class="n">ProvidePasswordCredential</span> <span class="p">|</span>
                                             <span class="n">DevicePairingKinds</span><span class="p">.</span><span class="n">ProvidePin</span><span class="p">;</span>

     <span class="c1">//sets all the possible protecton levels. Windows will choose the most secure option</span>
     <span class="c1">//compatible with both devices</span>
     <span class="n">DevicePairingProtectionLevel</span> <span class="n">minProtectionLevel</span> <span class="p">=</span> <span class="n">DevicePairingProtectionLevel</span><span class="p">.</span><span class="n">None</span> <span class="p">|</span>
                                                       <span class="n">DevicePairingProtectionLevel</span><span class="p">.</span><span class="n">Default</span> <span class="p">|</span>
                                                       <span class="n">DevicePairingProtectionLevel</span><span class="p">.</span><span class="n">Encryption</span> <span class="p">|</span>
                                                       <span class="n">DevicePairingProtectionLevel</span><span class="p">.</span><span class="n">EncryptionAndAuthentication</span><span class="p">;</span>

     <span class="c1">//starts the pairing process. It´s possible to call an overload with custom event handler, but</span>
     <span class="c1">//since no pairing handle has been passed, the default one will be used</span>
     <span class="n">PairingResult</span> <span class="n">pairedDevice</span> <span class="p">=</span> <span class="k">await</span> <span class="n">PairingService</span><span class="p">.</span><span class="n">PairDevice</span><span class="p">(</span><span class="n">connectionDevice</span><span class="p">,</span> <span class="n">ceremonySelection</span><span class="p">,</span> <span class="n">minProtectionLevel</span><span class="p">);</span>

     <span class="c1">//creates the discovery service</span>
     <span class="n">IGattDiscoveryService</span> <span class="n">discoveryService</span> <span class="p">=</span> <span class="k">await</span> <span class="n">GattDiscoveryService</span><span class="p">.</span><span class="n">CreateAsync</span><span class="p">(</span><span class="n">connectionDevice</span><span class="p">);</span>

     <span class="c1">//creates Guid object from Heart Rate Service`s 16 bit uuid</span>
     <span class="n">Guid</span> <span class="n">uuid</span> <span class="p">=</span> <span class="n">BluetoothUuidHelper</span><span class="p">.</span><span class="n">FromShortId</span><span class="p">(</span><span class="m">0</span><span class="n">x180D</span><span class="p">);</span>


     <span class="c1">//requests all the Services from the remote device</span>
     <span class="n">GattDeviceServicesResult</span> <span class="n">gattResult</span> <span class="p">=</span> <span class="k">await</span> <span class="n">discoveryService</span><span class="p">.</span><span class="n">GetAllGattServicesAsync</span><span class="p">();</span>

     <span class="c1">//iterates over the resulted services</span>
     <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">service</span> <span class="k">in</span> <span class="n">gattResult</span><span class="p">.</span><span class="n">Services</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="c1">//obtains the characteristics of the service</span>
         <span class="n">GattCharacteristicsResult</span> <span class="n">characteristics</span><span class="p">;</span>
         <span class="n">characteristics</span> <span class="p">=</span> <span class="k">await</span> <span class="n">service</span><span class="p">.</span><span class="n">GetCharacteristicsAsync</span><span class="p">().</span><span class="n">ToTask</span><span class="p">();</span>

         <span class="c1">//iterates over the resulted characteristics</span>
         <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">characteristic</span> <span class="k">in</span> <span class="n">characteristics</span><span class="p">.</span><span class="n">Characteristics</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="c1">//subscribes to all notifing characteristics, if supported</span>
             <span class="kt">var</span> <span class="n">notifyResult</span> <span class="p">=</span> <span class="k">await</span> <span class="n">characteristic</span><span class="p">.</span><span class="n">SubscribeToNotification</span>
                                 <span class="p">(</span>
                                     <span class="c1">// passes an action to handle the notification events</span>
                                     <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="p">=&gt;</span>
                                     <span class="p">{</span>
                                         <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;notification:&quot;</span><span class="p">);</span>
                                         <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
                                         <span class="n">IBuffer</span> <span class="n">CharacteristicValue</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">CharacteristicValue</span><span class="p">;</span>
                                         <span class="kt">string</span> <span class="n">val</span> <span class="p">=</span> <span class="n">ClientBufferReader</span><span class="p">.</span><span class="n">ToUTF8String</span><span class="p">(</span><span class="n">CharacteristicValue</span><span class="p">);</span>
                                         <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;buffer content: &quot;</span> <span class="p">+</span> <span class="n">val</span><span class="p">);</span>
                                     <span class="p">},</span>
                                     <span class="c1">//passes an action to handle exceptions raised during the subscription</span>
                                     <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">)</span>
                                 <span class="p">);</span>

                             <span class="c1">//to unsubscribe from notifications</span>
                             <span class="kt">var</span> <span class="n">unsubResult</span> <span class="p">=</span> <span class="k">await</span> <span class="n">characteristic</span><span class="p">.</span><span class="n">UnSubscribe</span><span class="p">();</span>
         <span class="p">}</span>
     <span class="p">}</span>

     <span class="c1">//when finished: clear, unpair and disconnect</span>
     <span class="n">discoveryService</span><span class="p">.</span><span class="n">ClearServices</span><span class="p">();</span>
     <span class="kt">var</span> <span class="n">unpairResult</span> <span class="p">=</span> <span class="k">await</span> <span class="n">PairingService</span><span class="p">.</span><span class="n">Unpair</span><span class="p">(</span><span class="n">connectionDevice</span><span class="p">);</span>
     <span class="n">connectionDevice</span><span class="p">.</span><span class="n">ClearBluetoothLEDevice</span><span class="p">();</span>
 <span class="p">}</span>
 <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="unpairing-and-disconnect">
<h2>Unpairing and disconnect<a class="headerlink" href="#unpairing-and-disconnect" title="Permalink to this headline"></a></h2>
<p>First all the services that have been discovered should be cleared. They are saved into the GattDiscoveryService, and the ClearServices method can be called to clear them.
To unpair the Unpair method of the PairingService class should be called, passing the instance of the remote device to unpair.
Finally the remote device shoud be cleared calling the method ClearBluetoothLEDevice.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Unpair and disconnect</span><a class="headerlink" href="#id4" title="Permalink to this code"></a></div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span> <span class="n">discoveryService</span><span class="p">.</span><span class="n">ClearServices</span><span class="p">();</span>
 <span class="kt">var</span> <span class="n">unpairResult</span> <span class="p">=</span> <span class="k">await</span> <span class="n">PairingService</span><span class="p">.</span><span class="n">Unpair</span><span class="p">(</span><span class="n">connectionDevice</span><span class="p">);</span>
 <span class="n">connectionDevice</span><span class="p">.</span><span class="n">ClearBluetoothLEDevice</span><span class="p">();</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to CosmedBleLib’s documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="DiscoveringDevices.html" class="btn btn-neutral float-right" title="Discovering devices" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Stefano Urani.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>